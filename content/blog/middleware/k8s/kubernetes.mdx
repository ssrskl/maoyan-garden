---
title: Kubernetes
description: Kubernetes æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€‚
date: 2025-07-05 22:13:00
tags: ["Kubernetes", "å®¹å™¨åŒ–", "åˆ†å¸ƒå¼"]
published: true
---

# Kubernetes æ ¸å¿ƒæŒ‡å—

---

## ğŸ“¦ Kubernetes éƒ¨ç½²

### æ„å»º Pod

å°½ç®¡ Kubernetes å¯ä»¥ç¼–æ’å’Œè¿è¡Œå®¹å™¨ï¼Œä½†è¿™äº›å®¹å™¨ä¸å¾—ä¸è¢«åŒ…è£…åœ¨ä¸€ä¸ªå« **Pod** çš„ Kubernetes ç»“æ„ä¸­ã€‚å°±æŠŠ Pod æƒ³è±¡æˆä¸€ä¸ªå›´ç»•å®¹å™¨çš„è½»é‡çº§åŒ…è£…å™¨ã€‚äº‹å®ä¸Šï¼Œæˆ‘ä»¬æœ‰æ—¶ä¼šäº’æ¢ä½¿ç”¨å®¹å™¨å’Œ Pod è¿™ä¸¤ä¸ªæœ¯è¯­ã€‚ç°åœ¨ï¼Œä½ åªéœ€è¦çŸ¥é“ **Kubernetes åœ¨ Pod ä¸­è¿è¡Œå®¹å™¨**ã€‚

è¦éƒ¨ç½²çš„ Pod æ˜¯åœ¨ä¸€ä¸ªå« `pod.yml` çš„ YAML æ–‡ä»¶ä¸­å®šä¹‰çš„ï¼š

```yaml
apiVersion: v1
kind: Pod 
metadata:
  name: first-pod
  labels:
    project: qsk-book 
spec:
  containers:
  - name: web 
    image: nigelpoulton/qsk-book:1.0 
    ports:
    - containerPort: 8080
```

![](./imgs/image.png)

**æŸ¥è¯¢è¿è¡Œçš„ Podï¼š**

```bash
kubectl get pods
```

**éƒ¨ç½² Podï¼š**

```bash
$ kubectl apply -f pod.yml
pod/first-pod created
ã€€
$ kubectl get pods 
NAME          READY       STATUS    RESTARTS      AGE
first-pod     1/1         Running       0         10s
```

`kubectl` æä¾›äº† `get` å’Œ `describe` ä¸¤ä¸ªå‘½ä»¤æ¥æŸ¥è¯¢å¯¹è±¡çš„é…ç½®å’ŒçŠ¶æ€ï¼š

```bash
kubectl describe pod first-pod
kubectl get pod first-pod
```

<Callout type="info">
    **æç¤ºï¼š** 
    å°½ç®¡ Pod å·²ç»å¯åŠ¨ï¼Œåº”ç”¨æ­£åœ¨è¿è¡Œï¼Œä½†ä½ è¿˜éœ€è¦å¦ä¸€ä¸ª Kubernetes å¯¹è±¡æ‰èƒ½åœ¨ç½‘ç»œä¸Šè¿æ¥åˆ°è¯¥åº”ç”¨
</Callout>

---

### è¿æ¥åˆ° Pod

è¿æ¥åˆ° Pod ä¸­çš„åº”ç”¨éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œç§°ä¸º **Serviceï¼ˆæœåŠ¡ï¼‰**ã€‚Service å¯¹è±¡çš„å”¯ä¸€ç”¨é€”æ˜¯æä¾›åˆ°ä¸ Pod ä¸­è¿è¡Œçš„åº”ç”¨çš„ç¨³å®šç½‘ç»œè¿é€šæ€§ã€‚

`svc-cloud.yml` æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ª Service å¯¹è±¡ï¼Œä»¥ä¾¿åœ¨ä½ çš„é›†ç¾¤åœ¨äº‘ä¸­æ—¶æä¾›è¿æ¥ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: cloud-lb
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 8080
  selector:
    project: qsk-book
```

`spec.type: LoadBalancer` å­—æ®µå‘Šè¯‰ Kubernetes åœ¨åº•å±‚äº‘å¹³å°ä¸Šé…ç½®ä¸€ä¸ªé¢å‘äº’è”ç½‘çš„è´Ÿè½½å‡è¡¡å™¨ã€‚è¯¥è´Ÿè½½å‡è¡¡å™¨å°†åœ¨ **80 ç«¯å£**æ¥æ”¶æµé‡ï¼Œå¹¶è½¬å‘åˆ°ä»»ä½•å¸¦æœ‰ `project: qsk-book` æ ‡è®°çš„ Pod çš„ **8080 ç«¯å£**ã€‚

---

### éƒ¨ç½² Service

åŒæ ·çš„ä¹Ÿæ˜¯é€šè¿‡ `apply` æ¥éƒ¨ç½² Serviceï¼š

```bash
$ kubectl apply -f svc-local.yml
service/svc-local created
```

ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥éªŒè¯è¯¥ Service å·²ç»å¯åŠ¨å’Œè¿è¡Œï¼š

```bash
$ kubectl get svc
NAME      TYPE     CLUSTER-IP    EXTERNAL-IP PORT(S)       AGE
svc-local NodePort 10.108.72.184 <none>      80:31111/TCP  11s
```

- **CLUSTER-IP** å€¼æ˜¯å†…éƒ¨ Kubernetes Pod ç½‘ç»œä¸Šçš„ä¸€ä¸ª IP åœ°å€ï¼Œè¢«é›†ç¾¤ä¸Šè¿è¡Œçš„å…¶ä»– Pod å’Œåº”ç”¨ä½¿ç”¨ã€‚

---

### æ¸…ç† Kubernetes

**æ¸…ç† Serviceï¼š**

```shell
$ kubectl delete svc cloud-lb
service "cloud-lb" deleted
```

**æ¸…ç† Podï¼š**

```shell
$ kubectl delete pod first-pod 
pod "first-pod" deleted
```

---

## ğŸ”„ è‡ªæˆ‘ä¿®å¤

ğŸ“š [å®˜æ–¹æ–‡æ¡£ï¼šDeployment](https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/)

æœ‰å¦ä¸€ä¸ªç§°ä¸º **Deployment** çš„ä¸“ç”¨å¯¹è±¡ï¼Œç”¨äºæä¾›**è‡ªæˆ‘ä¿®å¤ï¼ˆself-healingï¼‰**ã€‚äº‹å®ä¸Šï¼ŒDeployment ä¹Ÿå¯ä»¥å®ç°æ‰©ç¼©å®¹å’Œæ»šåŠ¨æ›´æ–°ã€‚Deployment ç”¨äºç®¡ç†è¿è¡Œä¸€ä¸ªåº”ç”¨è´Ÿè½½çš„ä¸€ç»„ Podï¼Œé€šå¸¸é€‚ç”¨äºä¸ä¿æŒçŠ¶æ€çš„è´Ÿè½½ã€‚

![image](./imgs/self-repair.png)

### æ ¸å¿ƒç»„æˆ

1. **å®¹å™¨**æä¾›æ“ä½œç³»ç»Ÿå’Œå…¶ä»–åº”ç”¨ä¾èµ–ã€‚
2. **Pod** æä¾›å…ƒæ•°æ®å’Œå…¶ä»–ç»“æ„ï¼Œä»¥ä¾¿å®¹å™¨åœ¨ Kubernetes ä¸Šè¿è¡Œã€‚
3. **Deployment** æä¾›äº‘åŸç”ŸåŠŸèƒ½ï¼ŒåŒ…æ‹¬è‡ªæˆ‘ä¿®å¤ã€‚

---

### Deployment å·¥ä½œæœºåˆ¶

æœ‰ä¸¤ä¸ªå…ƒç´ å¯¹ Deployment çš„å·¥ä½œå¾ˆé‡è¦ï¼š

1. **Deployment å¯¹è±¡**ï¼šæ˜¯å®šä¹‰ Pod å’Œå®¹å™¨çš„ YAML é…ç½®ã€‚å®ƒè¿˜å®šä¹‰äº†è¦éƒ¨ç½²å¤šå°‘ä¸ª Pod å‰¯æœ¬ç­‰äº‹é¡¹ã€‚
2. **Deployment æ§åˆ¶å™¨**ï¼šæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨æ§åˆ¶é¢æ¿ä¸Šçš„è¿›ç¨‹ï¼Œå®ƒå§‹ç»ˆåœ¨ç›‘æ§é›†ç¾¤ï¼Œç¡®ä¿æ‰€æœ‰çš„ Deployment å¯¹è±¡éƒ½æŒ‰è§„å®šè¿è¡Œã€‚

å‡è®¾ä½ åœ¨ Kubernetes çš„ Deployment æ¸…å•ä¸­å®šä¹‰äº†ä¸€ä¸ªåº”ç”¨ã€‚å®ƒå®šä¹‰äº†åä¸º `zephyr-one` çš„ Pod çš„ **5 ä¸ªå‰¯æœ¬**ã€‚ä½ ä½¿ç”¨ `kubectl` å°†å…¶å‘é€ç»™ Kubernetesï¼ŒKubernetes å°† 5 ä¸ª Pod è°ƒåº¦åˆ°é›†ç¾¤ä¸Šã€‚åœ¨è¿™ä¸€ç‚¹ä¸Šï¼Œ**è§‚å¯Ÿåˆ°çš„çŠ¶æ€ï¼ˆobserved stateï¼‰** ä¸**æœŸæœ›çŠ¶æ€ï¼ˆdesired stateï¼‰** ä¸€è‡´ã€‚è¿™æ˜¯ä¸“ä¸šçš„è¯´æ³•ï¼Œè¯´çš„æ˜¯é›†ç¾¤æ­£åœ¨è¿è¡Œä½ è¦æ±‚å®ƒè¿è¡Œçš„å†…å®¹ã€‚

ä½†æ˜¯ï¼Œå‡è®¾ä¸€ä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœäº†ï¼Œåä¸º `zephyr-one` çš„ Pod æ•°é‡ä¸‹é™åˆ° 4 ä¸ªã€‚è§‚å¯Ÿåˆ°çš„çŠ¶æ€ä¸å†ä¸æœŸæœ›çŠ¶æ€ç›¸åŒ¹é…ï¼Œæ­¤æ—¶å°±å‡ºç°äº†é—®é¢˜ã€‚ä½†ä¸è¦ç´§å¼ ï¼ŒDeployment æ§åˆ¶å™¨ç›‘è§†ç€é›†ç¾¤ï¼Œå¹¶å°†çœ‹åˆ°è¿™ä¸€å˜åŒ–ã€‚å®ƒçŸ¥é“ä½ æƒ³è¦ 5 ä¸ª Podï¼Œä½†å®ƒåªèƒ½è§‚å¯Ÿåˆ° 4 ä¸ªã€‚å› æ­¤ï¼Œå®ƒå°†å¯åŠ¨ç¬¬ 5 ä¸ª Podï¼Œä½¿è§‚å¯Ÿåˆ°çš„çŠ¶æ€é‡æ–°ä¸æœŸæœ›çŠ¶æ€ä¿æŒä¸€è‡´ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯¹åº”çš„æŠ€æœ¯æœ¯è¯­æ˜¯**å’Œè§£ï¼ˆreconciliationï¼‰**ï¼Œä½†æˆ‘ä»¬ç»å¸¸ç§°å…¶ä¸º**è‡ªæˆ‘ä¿®å¤**ã€‚

---

### Deployment é…ç½®ç¤ºä¾‹

```yaml
kind: Deployment         # <<== è¢«å®šä¹‰çš„å¯¹è±¡çš„ç±»å‹
apiVersion: apps/v1      # <<== è¦éƒ¨ç½²çš„å¯¹è±¡çš„ç‰ˆæœ¬
metadata:
  name: qsk-deploy            
spec:
  replicas: 5            # <<== è¦éƒ¨ç½²å¤šå°‘ä¸ª Pod å‰¯æœ¬
  selector:
    matchLabels:         # <<== å‘Šè¯‰ Deployment æ§åˆ¶å™¨
      project: qsk-book  # <<== ç®¡ç†å“ªäº› Pod
  template:
    metadata:
      labels:
        project: qsk-book # <<== Pod æ ‡ç­¾
    spec:   
      containers:
      - name: qsk-pod
        imagePullPolicy: Always  # <<== æ°¸è¿œä¸ä½¿ç”¨æœ¬åœ°é•œåƒ
        ports:
        - containerPort: 8080             # <<== ç½‘ç»œç«¯å£
        image: nigelpoulton/qsk-book:1.0  # <<== è¦ä½¿ç”¨çš„é•œåƒ
```

**æŸ¥è¯¢ Deploymentsï¼š**

```shell
kubectl get deployments
```

**éƒ¨ç½² Deploymentsï¼š**

```shell
$ kubectl apply -f deploy.yml
deployment.apps/qsk-deploy created
```

Pod å’Œå®ƒä»¬è¿è¡Œçš„åº”ç”¨æœ‰å¯èƒ½å´©æºƒæˆ–å‘ç”Ÿæ•…éšœã€‚Kubernetes å¯ä»¥é€šè¿‡å¯åŠ¨ä¸€ä¸ªæ–°çš„ Pod æ¥æ›¿ä»£å¤±è´¥çš„ Podï¼Œä»è€Œå°è¯•è‡ªæˆ‘ä¿®å¤è¿™æ ·çš„æƒ…å†µã€‚

---

## ğŸ“Š åº”ç”¨æ‰©ç¼©å®¹

### åº”ç”¨æ‰©å®¹

æ‰©ç¼©å®¹çš„å•ä½æ˜¯ **Pod**ï¼Œå› æ­¤æ‰©å®¹å°†å¢åŠ  Pod å‰¯æœ¬ï¼Œè€Œç¼©å®¹å°†åˆ é™¤ Pod å‰¯æœ¬ã€‚

æ‰‹åŠ¨ç¼–è¾‘ Deployment YAML æ–‡ä»¶ï¼Œå°†å‰¯æœ¬çš„æ•°é‡å¢åŠ åˆ° **10 ä¸ª**ï¼Œå¹¶é‡æ–°å°†å…¶å‘é€ç»™ Kubernetesã€‚

**æ£€æŸ¥å½“å‰çš„å‰¯æœ¬æ•°é‡ï¼š**

```shell
$ kubectl get deployment qsk-deploy
NAME          READY   UP-TO-DATE   AVAILABLE   AGE
qsk-deploy    5/5     5            5           16h
```

ç¼–è¾‘ `deploy.yml` æ–‡ä»¶ï¼Œå°† `spec.replicas` å­—æ®µè®¾ç½®ä¸º **10**ï¼Œå¹¶ä¿å­˜ä¿®æ”¹ï¼š

```yaml
apiVersion: apps/v1
kind: Deployment 
metadata:
  name: qsk-deploy 
spec:
  replicas: 5           # <<== å°†è¿™é‡Œæ”¹æˆ 10
  selector: 
    matchLabels: 
      project: qsk-book 
<Snip>
```

ä½¿ç”¨ `kubectl` å°†æ›´æ–°çš„æ–‡ä»¶é‡æ–°å‘é€ç»™ Kubernetesã€‚å½“ Kubernetes æ”¶åˆ°è¯¥æ–‡ä»¶æ—¶ï¼Œå®ƒå°†æŠŠæœŸæœ›çŠ¶æ€ä» **5 ä¸ªå‰¯æœ¬**æ”¹ä¸º **10 ä¸ª**ã€‚Deployment æ§åˆ¶å™¨å°†è§‚å¯Ÿé›†ç¾¤ä¸Šçš„ 5 ä¸ªå‰¯æœ¬ï¼Œå¹¶æ³¨æ„åˆ°å®ƒä¸ç¬¦åˆæ–°çš„æœŸæœ›çŠ¶æ€ã€‚å®ƒå°†è°ƒåº¦ 5 ä¸ªæ–°å‰¯æœ¬ï¼Œä½¿è§‚å¯Ÿåˆ°çš„çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€ä¸€è‡´ã€‚

---

### åº”ç”¨ç¼©å®¹

åº”ç”¨ç¼©å®¹åœ¨æœ¬èŠ‚ä¸­ï¼Œä½ å°†ä½¿ç”¨ `kubectl scale` å‘½ä»¤å°† Pod çš„æ•°é‡ç¼©å‡å› **5 ä¸ª**ã€‚è¿™ç§æ–¹æ³•è¢«ç§°ä¸º**å‘½ä»¤å¼æ–¹æ³•**ï¼Œä¸åƒå£°æ˜å¼æ–¹æ³•é‚£æ ·å¸¸è§ã€‚

```shell
$ kubectl scale --replicas 5 deployment/qsk-deploy
deployment.apps/qsk-deploy scaled
```

> **æ³¨æ„ï¼šç”¨ kubectl scale å‘½ä»¤å¼åœ°å®Œæˆæ‰©ç¼©å®¹æ“ä½œä¼šå¾ˆå±é™©ã€‚**

---

## ğŸ” æ»šåŠ¨æ›´æ–°

å³ä½¿ Kubernetes ä»¥æœ‰æ¡ä¸ç´Šçš„æ–¹å¼æ¯æ¬¡æ›´æ–° **1 ä¸ªå‰¯æœ¬**ï¼Œç›´åˆ° 5 ä¸ªå‰¯æœ¬éƒ½è¿è¡Œæ–°ç‰ˆæœ¬ã€‚

### æ›´æ–°é…ç½®æ–‡ä»¶

æ›´æ–° `deploy.yml` æ–‡ä»¶ï¼š

```yaml
1 apiVersion: apps/v1
2 kind: Deployment 
3 metadata:
4   name: qsk-deploy 
5 spec:
6   replicas: 5 
7   selector:
8     matchLabels:
9       project: qsk-book 
10  minReadySeconds: 20            # <<== æ·»åŠ è¿™ä¸€è¡Œ
11  strategy:                      # <<== æ·»åŠ è¿™ä¸€è¡Œ
12    type: RollingUpdate          # <<== æ·»åŠ è¿™ä¸€è¡Œ
13    rollingUpdate:               # <<== æ·»åŠ è¿™ä¸€è¡Œ
14      maxSurge: 1                # <<== æ·»åŠ è¿™ä¸€è¡Œ
15      maxUnavailable: 0          # <<== æ·»åŠ è¿™ä¸€è¡Œ
16  template:
17    metadata:
18      labels:
19        project: qsk-book 
20    spec:
21      containers:
22      - name: hello-pod 
23        imagePullPolicy: Always 
24        ports:
25        - containerPort: 8080 
26        image: nigelpoulton/qsk-book:1.1 # <<== è®¾ç½®ä¸º 1.1
```

---

### é…ç½®å‚æ•°è¯´æ˜

- **`minReadySeconds: 20`**ï¼šå‘Šè¯‰ Kubernetes åœ¨æ›´æ–°æ¯ä¸ªå‰¯æœ¬åè¦ç­‰å¾… **20 ç§’**ã€‚

<Callout type="info">
    **æç¤ºï¼š** 
    Kubernetes å®é™…ä¸Šæ²¡æœ‰æ›´æ–°å‰¯æœ¬ï¼Œå®ƒæ‰€åšçš„æ˜¯åˆ é™¤ç°æœ‰çš„å‰¯æœ¬ï¼Œå¹¶ç”¨ä¸€ä¸ªè¿è¡Œæ–°ç‰ˆæœ¬çš„å…¨æ–°å‰¯æœ¬æ¥ä»£æ›¿å®ƒä»¬
</Callout>

- **æ›´æ–°ç±»å‹ä¸º RollingUpdate**ï¼šä»¥æ»šåŠ¨æ›´æ–°çš„æ–¹å¼æ‰§è¡Œå¯¹æ­¤ Deployment çš„æ‰€æœ‰æ›´æ–°
- ç¬¬ **14** è¡Œå’Œç¬¬ **15** è¡Œå¼ºåˆ¶ Kubernetes ä¸€æ¬¡æ›´æ–°ä¸€ä¸ª Podï¼Œè¿è¡Œæœºåˆ¶æ˜¯ï¼š
  - ç¬¬ 14 è¡Œä¸­ `maxSurge=1` å…è®¸ Kubernetes åœ¨æ›´æ–°æ“ä½œä¸­å¢åŠ ä¸€ä¸ªé¢å¤–çš„ Podï¼ŒæœŸæœ›çŠ¶æ€éœ€è¦ 5 ä¸ª Podï¼Œæ‰€ä»¥ Kubernetes å¯ä»¥åœ¨æ›´æ–°æœŸé—´å°†å…¶å¢åŠ åˆ° 6 ä¸ª
  - ç¬¬ 15 è¡Œä¸­ `maxUnavailable=0` é˜²æ­¢ Kubernetes åœ¨æ›´æ–°æœŸé—´å‡å°‘ Pod çš„æ•°é‡ï¼ŒæœŸæœ›çŠ¶æ€è¿˜æ˜¯éœ€è¦ 5 ä¸ª Podï¼Œæ‰€ä»¥ Kubernetes ä¸å…è®¸æ¯”è¿™æ›´å°‘
  - ç»“åˆèµ·æ¥ï¼Œç¬¬ 14 è¡Œå’Œç¬¬ 15 è¡Œè¿«ä½¿ Kubernetes åˆ é™¤è¿è¡Œæ—§ç‰ˆæœ¬çš„å‰¯æœ¬çš„åŒæ—¶å¢åŠ è¿è¡Œæ–°ç‰ˆæœ¬çš„ç¬¬å…­ä¸ªå‰¯æœ¬ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸€ç›´é‡å¤ï¼Œç›´åˆ° 5 ä¸ªå‰¯æœ¬å…¨éƒ½åœ¨è¿è¡Œéœ€è¦çš„ç‰ˆæœ¬ã€‚

---

### ç›‘å¬æ»šåŠ¨æ›´æ–°è¿‡ç¨‹

å½“æ›´æ–°å®Œæ¯• `deploy.yml` åå¯ä»¥ä½¿ç”¨ `apply` å‘½ä»¤è¿›è¡Œéƒ¨ç½²ï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œç›‘å¬ï¼š

```shell
$ kubectl rollout status deployment qsk-deploy
Waiting for rollout to finish: 1 out of 5 have been updated...
Waiting for rollout to finish: 1 out of 5 have been updated...
Waiting for rollout to finish: 2 out of 5 have been updated...
Waiting for rollout to finish: 2 out of 5 have been updated...
Waiting for rollout to finish: 3 out of 5 have been updated...
Waiting for rollout to finish: 3 out of 5 have been updated...
Waiting for rollout to finish: 4 out of 5 have been updated...
Waiting for rollout to finish: 4 out of 5 have been updated...
Waiting for rollout to finish: 2 old replicas are pending termination...
Waiting for rollout to finish: 1 old replicas are pending termination...
deployment "qsk-deploy" successfully rolled out
```