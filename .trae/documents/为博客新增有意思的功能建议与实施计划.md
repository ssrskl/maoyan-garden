# Glossary 悬浮卡片优化

## 现状

* 组件：`components/dict-tooltip.tsx`（`DictTooltip` + `HoverCard`）

* 数据：`content/dict/glossary.ts`

* 插件：`lib/rehype-dict/index.ts`（将术语文本替换为 `<DictTooltip>`）

* MDX 接入：`velite.config.ts` 启用 `rehypeDict`，`components/mdx-components.tsx` 注册组件

## 主要优化方向

### 1) 匹配与性能

* 术语正则缓存：在 `rehype-dict` 初始化阶段一次性构建并缓存复合正则，避免每节点重建。

* 词边界与大小写：支持多语言边界与大小写可选匹配，减少误命中；允许在 `glossary.ts` 为特定词配置 `exact: true`。

* 去重与嵌套保护：避免标题、链接等高频处重复包裹；保留对 `a/code/pre` 的排除，并增加 `kbd/button` 排除白名单。

* 批量替换：将 AST 文本分片合并处理，减少节点拆分次数，提升构建效率。

### 2) 视觉与交互

* 延时触发与“保持开启”：悬停 150ms 延时，支持点击锁定卡片；移动端使用 `tap` 呼出、外部点击关闭。

* 位置与溢出：根据视窗自动选择 `top/bottom`，卡片宽度在移动端收窄，长定义滚动显示。

* 富内容：在卡片中显示 `links`（相关外链/站内链接）、`contributors`（来源）、术语类型徽标；支持多段文本与代码块。

### 3) 无障碍（a11y）与键盘

* 可聚焦：`DictTooltip` 包裹元素可 `tab` 聚焦，`Enter`/`Space` 打开，`Esc` 关闭。

* ARIA 属性：为卡片与触发器补充 `aria-controls/aria-expanded/role=dialog`。

### 4) 数据与维护

* 同义词与别名：在 `glossary.ts` 支持 `aliases` 字段；`rehype-dict` 统一映射到主词条。

* 精准控制：支持在文章 frontmatter 中加入 `dict: false` 关闭全局替换；或 `dict: ["仅启用词"]` 白名单。

### 5) 统计与评估

* 事件收集：打开卡片、停留时长、点击外链上报（可选接入 Plausible/Umami）。

* 热点词条榜：记录高频术语，生成“术语热力图”，用于扩充词典与内容创作。

## 实施步骤

1. `rehype-dict` 优化：正则缓存、白名单/黑名单扩展、aliases 支持、frontmatter 控制开关。
2. `DictTooltip` 交互升级：延时触发、锁定模式、a11y 键盘支持、移动端布局优化。
3. 词典数据扩展：为核心术语补充 `links` 与 `aliases`，定义类型徽章。
4. 统计埋点：抽象 `track(event, payload)`，后续可无侵入接入分析服务。
5. 文档与示例：在一篇文章中演示多种术语卡片样式与交互，验证表现。

## 风险与回退

* 若正则改造导致构建变慢：保留旧实现的开关；对长文启用“按需词典”只匹配标题与首段。

* 移动端交互复杂度：提供最小可行版本（仅点击打开/关闭），逐步增强。

## 预估

* 总工作量：\~0.5 天；以组件与插件的局部改造为主，风险低。

