# 实现高级搜索与知识图谱页的详细方案

## 目标

* 提升搜索的准确性与可玩性：支持标签过滤、相关度排序与关键词高亮。
* 新增 `/map` 知识图谱页：以标签与关系连接文章，探索数字花园结构。
* 保持现有技术栈与风格一致：Next App Router、Velite 数据源、Tailwind/shadcn、Framer Motion。

## 功能拆分

1. 高级搜索

* 服务端改造：在 `app/api/search/route.ts` 支持 `tags`（多选）、`sort`（`relevance|date`）。
* 相关度评分：无外部依赖，使用权重匹配算法（`title:3, description:2, tags:2`），按匹配次数与权重累计得分，再按 `sort` 排序。
* 客户端 UI：
  * `app/search/search-content.tsx` 增加标签过滤条（多选 chip）、排序下拉、结果统计。
  * 标签来源：新增 `app/api/tags/route.ts` 返回标签统计（调用 `getAllTags` 已存在于 `lib/utils.ts:27-38`）。
  * 已实现的关键词高亮保持不变（`components/post-item.tsx`）。

2. 知识图谱页 `/map`

* 数据：基于 `@/.velite` 的 `posts`（`slug/title/tags/status`），首版以“共享标签”构边；后续可扩展“文章内链接”。
* 初版布局：不引入新库，使用 SVG + 简单布局（同心圆/分区圆），标签分区内按角度均匀摆放文章节点；边用 SVG 线段，hover 高亮相邻节点，点击跳转文章。
* 交互：标签过滤器（多选）、搜索框、缩放（简单 scale 方案）、动效（Framer Motion 轻量淡入/高亮）。
* 后续增强：如需更自然布局，增量引入 `d3-force` 或 `vis-network`（依赖较轻，按需加载）。

## 关键改动点（文件级）

* `app/api/search/route.ts`：
  * 解析 `q`、`tags`（逗号分隔）、`sort`。
  * 增加评分与排序逻辑，返回同样结构（`slug/title/description/date/tags`）。
* `app/api/tags/route.ts`：返回 `{ tags: { name: count } }`，来源 `posts`。
* `app/search/search-content.tsx`：
  * 从 `/api/tags` 拉取标签集，渲染多选 chip；状态改变时请求 `/api/search?q=...&tags=...&sort=...`。
  * 添加排序选择与总数显示，保留加载骨架与错误兜底。
* `app/map/page.tsx` + `app/map/map-content.tsx`：
  * 服务端页面包裹，客户端组件构图。
  * 构图算法：
    * 节点：文章（`id=slug`）与标签（`id=tag` 两种类型），文章与标签之间连边；也可直接按共享标签为文章互连。
    * 布局：将标签按出现频次分区，文章在对应分区均匀布点；计算连线并渲染 SVG。
  * 交互：标签多选过滤、节点 hover 高亮相邻、点击打开文章。

## 实现细节

* 评分实现（伪代码）：
  * `score = 0; if title includes(q) score += 3 * count; if description includes(q) score += 2 * count; if any tag includes(q) score += 2 * matches;`
  * 标签过滤：`post.tags` 与所选标签集交集非空才保留；支持多选。
  * 排序：`relevance` 默认按 `score desc`，`date` 按 `date desc`。
* 标签 API：`app/api/tags/route.ts` 直接复用 `getAllTags` 与 `sortTagsByCount` 输出有序列表。
* 图谱布局：
  * 统计标签出现频次，取 Top-N 标签作为分区；每个分区均匀分布其下文章（极坐标 -> (x,y)）。
  * 边渲染：文章-标签的线（灰色），hover 某节点时提升关联线与节点的透明度与颜色。
  * 控制：筛选标签后只显示相关子图；提供重置与回到中心。

## 验证与优化

* 搜索 API：对无查询/无标签的情况返回空或默认；接口健壮性与大小写兼容处理。
* 客户端：状态切换与防抖（200ms）减少请求频率；保持骨架与错误提示。
* 图谱：数据量小场景的性能验证；SVG 元素数量控制在合理范围。

## 预估工作量

* 高级搜索：0.5 天（含 API + UI）。
* 图谱页：0.5-1 天（首版 SVG 布局与交互）。

## 需要确认

* 标签过滤是否支持“必须包含全部所选标签”与“包含其一”两种模式（默认“包含其一”）。
* 图谱初版使用 SVG 布局即可；若后期需要更自然力导图，再增量引入 `d3-force`。